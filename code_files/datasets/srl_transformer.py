import os
import numpy as np

import json
from collections import Counter

from copy import deepcopy

from transformers import AutoTokenizer
import torch

class SRLDataset_transformer():
    def __init__(self, lang_data_path:str, va_dir_path:str):

        self.data = SRLDataset_transformer.load_data( lang_data_path )

        # adding roles
        self.id_to_roles = ['_'] + ['agent', 'asset', 'attribute', 'beneficiary', 'cause', 'co-agent', 'co-patient', 
                                    'co-theme', 'destination', 'experiencer', 'extent', 'goal', 'idiom', 'instrument', 'location', 
                                    'material', 'patient', 'product', 'purpose', 'recipient', 'result', 'source', 'stimulus', 
                                    'theme', 'time', 'topic', 'value']
        self.roles_to_id = {role:i for i,role in enumerate(self.id_to_roles)}

        # adding predicates (= frames)
        va_resources_path_dir = os.listdir(va_dir_path)[0] 
        self.id_to_predicates = ['_']
        with open( os.path.join(va_dir_path, va_resources_path_dir, 'VA_frame_info.tsv') ) as file:
            for line in file:
                l = line.strip('\n').split('\t')
                if len(l) > 2: # l[0] = va, l[1] = name
                    self.id_to_predicates.append(l[1])
            self.id_to_predicates.sort()

        # self.id_to_predicates = ['_'] + ["ABSORB","ABSTAIN_AVOID_REFRAIN","ACCOMPANY","ACCUSE","ACHIEVE","ADD","ADJUST_CORRECT","AFFECT","AFFIRM","AGREE_ACCEPT","AIR","ALLY_ASSOCIATE_MARRY","ALTERNATE","AMASS","AMELIORATE","ANALYZE","ANSWER","APPEAR","APPLY","APPROVE_PRAISE","ARGUE-IN-DEFENSE","AROUSE_WAKE_ENLIVEN","ARRIVE","ASCRIBE","ASK_REQUEST","ASSIGN-SMT-TO-SMN","ATTACH","ATTACK_BOMB","ATTEND","ATTRACT_SUCK","AUTHORIZE_ADMIT","AUTOMATIZE","AUX_MOD","BE-LOCATED_BASE","BEFRIEND","BEGIN","BEHAVE","BELIEVE","BEND","BENEFIT_EXPLOIT","BETRAY","BEWITCH","BID","BLIND","BORDER","BREAK_DETERIORATE","BREATH_BLOW","BRING","BULGE-OUT","BURDEN_BEAR","BURN","BURY_PLANT","BUY","CAGE_IMPRISON","CALCULATE_ESTIMATE","CANCEL_ELIMINATE","CARRY_TRANSPORT","CARRY-OUT-ACTION","CASTRATE","CATCH","CATCH_EMBARK","CAUSE-MENTAL-STATE","CAUSE-SMT","CAVE_CARVE","CELEBRATE_PARTY","CHANGE_SWITCH","CHANGE-APPEARANCE/STATE","CHANGE-HANDS","CHANGE-TASTE","CHARGE","CHASE","CHOOSE","CIRCULATE_SPREAD_DISTRIBUTE","CITE","CLOSE","CLOUD_SHADOW_HIDE","CO-OPT","COLOR","COMBINE_MIX_UNITE","COME-AFTER_FOLLOW-IN-TIME","COME-FROM","COMMUNE","COMMUNICATE_CONTACT","COMMUNIZE","COMPARE","COMPENSATE","COMPETE","COMPLEXIFY","CONQUER","CONSIDER","CONSUME_SPEND","CONTAIN","CONTINUE","CONTRACT-AN-ILLNESS_INFECT","CONVERT","COOK","COOL","COPY","CORRELATE","CORRODE_WEAR-AWAY_SCRATCH","CORRUPT","COST","COUNT","COURT","COVER_SPREAD_SURMOUNT","CREATE_MATERIALIZE","CRITICIZE","CRY","CUT","DANCE","DEBASE_ADULTERATE","DECEIVE","DECIDE_DETERMINE","DECREE_DECLARE","DEFEAT","DELAY","DERIVE","DESTROY","DEVELOP_AGE","DIET","DIM","DIP_DIVE","DIRECT_AIM_MANEUVER","DIRTY","DISAPPEAR","DISBAND_BREAK-UP","DISCARD","DISCUSS","DISLIKE","DISMISS_FIRE-SMN","DISTINGUISH_DIFFER","DIVERSIFY","DIVIDE","DOWNPLAY_HUMILIATE","DRESS_WEAR","DRINK","DRIVE-BACK","DROP","DRY","EARN","EAT_BITE","EMBELLISH","EMCEE","EMIT","EMPHASIZE","EMPTY_UNLOAD","ENCLOSE_WRAP","ENDANGER","ENJOY","ENTER","ESTABLISH","EXCRETE","EXEMPT","EXHAUST","EXIST_LIVE","EXIST-WITH-FEATURE","EXPLAIN","EXPLODE","EXTEND","EXTRACT","FACE_CHALLENGE","FACIAL-EXPRESSION","FAIL_LOSE","FAKE","FALL_SLIDE-DOWN","FEEL","FIGHT","FILL","FIND","FINISH_CONCLUDE_END","FIT","FLATTEN_SMOOTHEN","FLATTER","FLOW","FLY","FOCUS","FOLLOW_SUPPORT_SPONSOR_FUND","FOLLOW-IN-SPACE","FORGET","FRUSTRATE_DISAPPOINT","FUEL","GENERATE","GIVE_GIFT","GIVE-BIRTH","GIVE-UP_ABOLISH_ABANDON","GO-FORWARD","GROUND_BASE_FOUND","GROUP","GROW_PLOW","GUARANTEE_ENSURE_PROMISE","GUESS","HANG","HAPPEN_OCCUR","HARMONIZE","HAVE-A-FUNCTION_SERVE","HAVE-SEX","HEAR_LISTEN","HEAT","HELP_HEAL_CARE_CURE","HIRE","HIT","HOLE_PIERCE","HOST_MEAL_INVITE","HUNT","HURT_HARM_ACHE","IMAGINE","IMPLY","INCITE_INDUCE","INCLINE","INCLUDE-AS","INCREASE_ENLARGE_MULTIPLY","INFER","INFLUENCE","INFORM","INSERT","INTERPRET","INVERT_REVERSE","ISOLATE","JOIN_CONNECT","JOKE","JUMP","JUSTIFY_EXCUSE","KILL","KNOCK-DOWN","KNOW","LAND_GET-OFF","LAUGH","LEAD_GOVERN","LEARN","LEAVE_DEPART_RUN-AWAY","LEAVE-BEHIND","LEND","LIBERATE_ALLOW_AFFORD","LIE","LIGHT_SHINE","LIGHTEN","LIKE","LOAD_PROVIDE_CHARGE_FURNISH","LOCATE-IN-TIME_DATE","LOSE","LOWER","LURE_ENTICE","MAKE-A-SOUND","MAKE-RELAX","MANAGE","MATCH","MEAN","MEASURE_EVALUATE","MEET","MESS","METEOROLOGICAL","MISS_OMIT_LACK","MISTAKE","MOUNT_ASSEMBLE_PRODUCE","MOVE-BACK","MOVE-BY-MEANS-OF","MOVE-ONESELF","MOVE-SOMETHING","NAME","NEGOTIATE","NOURISH_FEED","OBEY","OBLIGE_FORCE","OBTAIN","ODORIZE","OFFEND_DISESTEEM","OFFER","OPEN","OPERATE","OPPOSE_REBEL_DISSENT","ORDER","ORGANIZE","ORIENT","OVERCOME_SURPASS","OVERLAP","PAINT","PARDON","PARTICIPATE","PAY","PERCEIVE","PERFORM","PERMEATE","PERSUADE","PLAN_SCHEDULE","PLAY_SPORT/GAME","POPULATE","POSSESS","PRECEDE","PRECLUDE_FORBID_EXPEL","PREPARE","PRESERVE","PRESS_PUSH_FOLD","PRETEND","PRINT","PROMOTE","PRONOUNCE","PROPOSE","PROTECT","PROVE","PUBLICIZE","PUBLISH","PULL","PUNISH","PUT_APPLY_PLACE_PAVE","QUARREL_POLEMICIZE","RAISE","REACH","REACT","READ","RECALL","RECEIVE","RECOGNIZE_ADMIT_IDENTIFY","RECORD","REDUCE_DIMINISH","REFER","REFLECT","REFUSE","REGRET_SORRY","RELY","REMAIN","REMEMBER","REMOVE_TAKE-AWAY_KIDNAP","RENEW","REPAIR_REMEDY","REPEAT","REPLACE","REPRESENT","REPRIMAND","REQUIRE_NEED_WANT_HOPE","RESERVE","RESIGN_RETIRE","RESIST","REST","RESTORE-TO-PREVIOUS/INITIAL-STATE_UNDO_UNWIND","RESTRAIN","RESULT_CONSEQUENCE","RETAIN_KEEP_SAVE-MONEY","REVEAL","RISK","ROLL","RUN","SATISFY_FULFILL","SCORE","SEARCH","SECURE_FASTEN_TIE","SEE","SEEM","SELL","SEND","SEPARATE_FILTER_DETACH","SETTLE_CONCILIATE","SEW","SHAPE","SHARE","SHARPEN","SHOOT_LAUNCH_PROPEL","SHOUT","SHOW","SIGN","SIGNAL_INDICATE","SIMPLIFY","SIMULATE","SING","SLEEP","SLOW-DOWN","SMELL","SOLVE","SORT_CLASSIFY_ARRANGE","SPEAK","SPEED-UP","SPEND-TIME_PASS-TIME","SPILL_POUR","SPOIL","STABILIZE_SUPPORT-PHYSICALLY","START-FUNCTIONING","STAY_DWELL","STEAL_DEPRIVE","STOP","STRAIGHTEN","STRENGTHEN_MAKE-RESISTANT","STUDY","SUBJECTIVE-JUDGING","SUBJUGATE","SUMMARIZE","SUMMON","SUPPOSE","SWITCH-OFF_TURN-OFF_SHUT-DOWN","TAKE","TAKE-A-SERVICE_RENT","TAKE-INTO-ACCOUNT_CONSIDER","TAKE-SHELTER","TASTE","TEACH","THINK","THROW","TIGHTEN","TOLERATE","TOUCH","TRANSLATE","TRANSMIT","TRAVEL","TREAT","TREAT-WITH/BY","TRY","TURN_CHANGE-DIRECTION","TYPE","UNDERGO-EXPERIENCE","UNDERSTAND","UNFASTEN_UNFOLD","USE","VERIFY","VIOLATE","VISIT",'WORK','WASH_CLEAN','WAIT','WARN','WELCOME','WATCH_LOOK-OUT','WIN','WORSEN','WRITE']
        # self.predicates_to_id = {pred:i for i,pred in enumerate(self.id_to_predicates)}


    @staticmethod
    def load_data(lang_data_path):
        """load the dataset

        Args:
            lang_data_path (str): 

        Returns:
            list: list of sentences.
        """
        f = open(lang_data_path)
        res = list(json.load( f ).values())
        f.close()
        return res

    def __len__(self):
        return len(self.data)

    def __getitem__(self, idx):
        return self.data[idx]